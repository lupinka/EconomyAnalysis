---
title: "EconomyAnalysis"
output: 
  html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen=999)
```

## Libraries installation
```{r cache=TRUE, warning=FALSE, message=FALSE}
r = getOption("repos")
r["CRAN"] = "http://cran.us.r-project.org"
options(repos = r)
install.packages("readxl")
install.packages("corrplot")
install.packages("plotly")
```
```{r warning=FALSE, message=FALSE}
library("readxl")
library(dplyr)
library(tidyr)
library(ggplot2)
library(mlbench)
library(corrplot)
library(caret)
library(plotly)
```

## Loading data

Path to directory with data

```{r savePath}
dataDirectoryPath <- 'C:/Users/anna/OneDrive/Nauka/II semestr II stopieÅ„/Zaawansowana Eksploracja Danych/Data pack/Data pack/'
```

Loading CurrencyExchangeRates.csv file

```{r}
currencyExchangeRatesPath <- paste0(dataDirectoryPath, 'CurrencyExchangeRates.csv')
currencyExchangeRates <- read.csv(currencyExchangeRatesPath)
```

Loading Gold prices.csv file

```{r}
goldPricesPath <- paste0(dataDirectoryPath, 'Gold prices.csv')
goldPrices <- read.csv(goldPricesPath)
```

Loading S&P Composite.csv file

```{r}
spCompositePath <- paste0(dataDirectoryPath, 'S&P Composite.csv')
spComposite <- read.csv(spCompositePath)
```

Loading World_Development_Indicators.xlsx file
```{r}
worldDevelopmentIndicatorsPath <- paste0(dataDirectoryPath, 'World_Development_Indicators.xlsx')
worldDevelopmentIndicators <- read_excel(worldDevelopmentIndicatorsPath)
```


## Cleaning worldDevelopmentIndicators data

```{r clean dataset, warning=FALSE}
cleanedWorldDevelopmentIndicators <- worldDevelopmentIndicators[c(1:42600, 43666:43878),]
cleanedWorldDevelopmentIndicators <- cleanedWorldDevelopmentIndicators %>% 
  mutate_at(vars(!c('Country Name', 'Country Code', 'Series Name', 'Series Code')), as.numeric) %>%
  pivot_longer(!c('Country Name', 'Country Code', 'Series Name', 'Series Code'), names_to = "year", values_to="value")
cleanedWorldDevelopmentIndicators$year <- substr(cleanedWorldDevelopmentIndicators$year,1,4)
cleanedWorldDevelopmentIndicatorsResult <- cleanedWorldDevelopmentIndicators %>% 
  pivot_wider(names_from = c('Series Name', 'Series Code'), values_from = 'value',  names_glue = "{`Series Name`}") %>%
  mutate_at(vars(year), as.numeric)
cleanedWorldDevelopmentIndicatorsResult[cleanedWorldDevelopmentIndicatorsResult == ".." | cleanedWorldDevelopmentIndicatorsResult == ""] <- NA
cleanedWorldDevelopmentIndicatorsResult <- cleanedWorldDevelopmentIndicatorsResult %>% select_if(colSums(!is.na(.)) > (nrow(cleanedWorldDevelopmentIndicatorsResult)/2))
```

## Filling missing data in world development indicators dataframe
```{r warning=FALSE}
n <- ncol(cleanedWorldDevelopmentIndicatorsResult)
missingValuesByCountry <- cleanedWorldDevelopmentIndicatorsResult %>% 
  group_by(`Country Name`) %>% 
  summarise_all(~sum(is.na(.))) %>% 
  transmute(`Country Name`, sumNA = rowSums(.[-1])) %>%
  arrange(desc(sumNA))
knitr::kable(head(missingValuesByCountry, 20))
```
```{r warning=FALSE}
worldIndicatorsComplementedDf <- cleanedWorldDevelopmentIndicatorsResult %>%
    group_by(`Country Name`) %>% 
    mutate_each(funs(replace(., which(is.na(.)), min(., na.rm=TRUE)))) %>%
    mutate_each(funs(replace(., which(is.infinite(.)), 0)))
names(worldIndicatorsComplementedDf) <- gsub(" ", "_", names(worldIndicatorsComplementedDf))
names(cleanedWorldDevelopmentIndicatorsResult) <- gsub(" ", "_", names(cleanedWorldDevelopmentIndicatorsResult))

knitr::kable(head(worldIndicatorsComplementedDf))

```

## Cleaning gold prices dataframe
```{r clean goldPrices}
goldPricesYearly <- goldPrices
goldPricesYearly$year <- substr(goldPrices$Date,1,4)
goldPricesYearly <- group_by(goldPricesYearly, year)
goldPricesYearly <- summarize(goldPricesYearly, 
                              gold_usd = mean(`USD..AM.`, na.rm=TRUE),
                              gold_gbp = mean(`GBP..AM.`, na.rm=TRUE),
                              gold_euro = mean(`EURO..AM.`, na.rm=TRUE))
knitr::kable(head(goldPricesYearly))
```

## Cleaning spComposite dataframe
```{r clean spComposite}
spCompositeYearly <- spComposite
spCompositeYearly$year <- substr(spComposite$Year,1,4)
spCompositeYearly <- group_by(spCompositeYearly, year)
spCompositeYearly <- summarize(spCompositeYearly, 
                              spComposite = mean(`S.P.Composite`, na.rm=TRUE),
                              dividend = mean(Dividend, na.rm=TRUE),
                              earnings = mean(Earnings, na.rm=TRUE),
                              cpi = mean(CPI, na.rm=TRUE),
                              longInterestRate = mean(`Long.Interest.Rate`, na.rm=TRUE),
                              realPrice = mean(`Real.Price`, na.rm=TRUE),
                              realDividend = mean(`Real.Dividend`, na.rm=TRUE),
                              realEarnings = mean(`Real.Earnings`, na.rm=TRUE),
                              cyclicallyAdjustedPERattio = mean(`Cyclically.Adjusted.PE.Ratio`,na.rm=TRUE),
                              )
knitr::kable(head(spCompositeYearly))
```

## Data summary

WorldDevelopmentIndicators summary
```{r summaryWorldDevelopmentIndicators}
knitr::kable(summary(cleanedWorldDevelopmentIndicatorsResult))
```

GoldPrices summary
```{r summaryGoldPrices}
knitr::kable(summary(goldPricesYearly))
```

SpComposite summary
```{r summarySpComposite}
knitr::kable(summary(spCompositeYearly))
```

CurrencyExchangerates summary
```{r summaryCurrencyExchangeRates}
knitr::kable(summary(currencyExchangeRates))
```

## Merge worldIndicators goldPrices and S&P composite 
```{r merge}
worldIndicatorsForWholeWorld <- worldIndicatorsComplementedDf %>%
  filter(Country_Name == 'World')

goldPricesAndWorldIndicators <- merge(x=worldIndicatorsForWholeWorld[-c(1,2)], y=goldPricesYearly[c('year','gold_usd')], by='year')
goldPricesAndSpcomposite = merge(x=goldPricesYearly[c('year','gold_usd')], y=spCompositeYearly, by='year')
```

## Finding world development indicators that influence gold prices the most
```{r whole-world}
control <- trainControl(method="repeatedcv", number=10, repeats=5)
rfGrid <- expand.grid(mtry = 10:30)
model <- train(
  gold_usd~., 
  data=goldPricesAndWorldIndicators, 
  method="rf", 
  na.action = na.pass,
  tuneGrid = rfGrid,
  ntree = 30,
  trControl=control)

importance <- arrange(varImp(model)$importance, desc(Overall)) 
mostImoortantIndicators_Gold <- head(importance, n=15)
knitr::kable(mostImoortantIndicators_Gold)
```

## Corelation Matrix of most importnant development indicators
```{r fig.height=120, fig.width=120}
names <- c(rownames(mostImoortantIndicators_Gold), 'year')
names <- gsub("`", "", all_of(names))
res <- cor(merge(worldIndicatorsComplementedDf[names], goldPricesAndSpcomposite, by='year'))
corrplot(res, method = 'square', order = 'AOE', type = 'lower', diag = FALSE,  tl.cex=6.75, cl.cex=4)
```

## Gold Prices factors diagramm
```{r goldPriceDiagramms}
g <- ggplot(
  goldPricesYearly, 
  aes(x=year, 
      y=gold_usd,
      group=1)
) +
scale_x_discrete(limits=goldPricesYearly$year,breaks=goldPricesYearly$year[seq(1,length(goldPricesYearly$year),by=5)]) +
geom_line()
ggplotly(g)
```
```{r goldPriceDiagramms2}
g <- ggplot(
  goldPricesAndWorldIndicators, 
  aes(x=`CO2_emissions_from_residential_buildings_and_commercial_and_public_services_(%_of_total_fuel_combustion)`, 
      y=gold_usd,
      group=1)
) +
geom_line()
ggplotly(g)
```
```{r goldPriceDiagramms3}
g <- ggplot(
  goldPricesAndWorldIndicators, 
  aes(x=`Birth_rate,_crude_(per_1,000_people)`, 
      y=gold_usd,
      group=1)
) +
geom_line()
ggplotly(g)
```
```{r goldPriceDiagramms4}
g <- ggplot(
  goldPricesAndWorldIndicators, 
  aes(x=Rural_population, 
      y=gold_usd,
      group=1)
) +
geom_line()
ggplotly(g)
```
```{r goldPriceDiagramms5}
g <- ggplot(
  goldPricesAndWorldIndicators, 
  aes(x=`GDP_(current_US$)`, 
      y=gold_usd,
      group=1)
) +
geom_line()
ggplotly(g)
```

## S&P Composite
```{r spCompositeDiagramms}
g <- ggplot(
  spCompositeYearly, 
  aes(x=year, 
      y=spComposite,
      group=1)
) +
geom_line()
ggplotly(g)
```

## GDP 
```{r fig.height=150, fig.width=12}
cleanedWorldDevelopmentIndicatorsResultWithoutWorld <- cleanedWorldDevelopmentIndicatorsResult %>%
    filter(Country_Name != 'World')
max_gdp_country = max(cleanedWorldDevelopmentIndicatorsResultWithoutWorld$`GDP_(current_US$)`, na.rm = TRUE)
scaleFactor <- max_gdp_country / max(cleanedWorldDevelopmentIndicatorsResultWithoutWorld$`GDP_per_capita_(current_US$)`, na.rm = TRUE)

g <- ggplot(
  cleanedWorldDevelopmentIndicatorsResultWithoutWorld,
  aes(x=year)
) +
geom_smooth(aes(y=`GDP_(current_US$)`),  method="loess", col="blue") +
geom_smooth(aes(y=`GDP_per_capita_(current_US$)` * scaleFactor),  method="loess", col="red") +
scale_y_continuous(name="GDP(current US$)", sec.axis=sec_axis(~./scaleFactor, name="GDP per capita(current US$)")) +
theme(
    axis.title.y.left=element_text(color="blue"),
    axis.text.y.left=element_text(color="blue"),
    axis.title.y.right=element_text(color="red"),
    axis.text.y.right=element_text(color="red")
  ) +
facet_wrap(vars(Country_Name), ncol = 4)
ggplotly(g)
```